#include <graphics.h>
#include <conio.h>
#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define MAXP 20

double nCr(int n, int r) {
    int i;
    double res = 1.0;
    if (r < 0 || r > n) return 0.0;
    if (r == 0 || r == n) return 1.0;
    if (r > n - r) r = n - r;
    for (i = 0; i < r; ++i) {
        res = res * (n - i) / (i + 1);
    }
    return res;
}

double safe_pow(double base, int exponent) {
    double result = 1.0;
    int i;
    
    if (exponent == 0) return 1.0;
    if (base == 0.0) return 0.0;
    
    for (i = 0; i < exponent; i++) {
        result *= base;
    }
    return result;
}

int main(void) {
    int gd = DETECT, gm;
    int i, n, degree;
    int maxx, maxy;
    int cx[MAXP], cy[MAXP];
    int prev_x, prev_y;
    int xi, yi;
    char label[16];
    double t, step, x, y;

    initgraph(&gd, &gm, "C:\\TURBOC3\\BGI");  

    printf("Enter number of control points (2..%d): ", MAXP);
    scanf("%d", &n);
    if (n < 2) {
        printf("Need at least 2 control points.\n");
        getch();
        closegraph();
        return 0;
    }
    if (n > MAXP) {
        printf("Maximum allowed is %d points.\n", MAXP);
        getch();
        closegraph();
        return 0;
    }

    maxx = getmaxx();
    maxy = getmaxy();
    printf("Screen size: %d x %d\n", maxx, maxy);
    for (i = 0; i < n; ++i) {
        printf("P%d (x y): ", i);
        scanf("%d %d", &cx[i], &cy[i]);
    }

    setcolor(WHITE);
    for (i = 0; i < n - 1; ++i) {
        line(cx[i], cy[i], cx[i + 1], cy[i + 1]);
    }

    for (i = 0; i < n; ++i) {
        setfillstyle(SOLID_FILL, YELLOW);
        circle(cx[i], cy[i], 4);
        floodfill(cx[i], cy[i], WHITE);
        sprintf(label, "P%d", i);
        outtextxy(cx[i] + 6, cy[i] - 6, label);
    }

    degree = n - 1;
    prev_x = prev_y = -1;
    step = 0.005;
    setcolor(GREEN);

    for (t = 0.0; t <= 1.0 + 1e-12; t += step) {
        x = 0.0;
        y = 0.0;
        for (i = 0; i <= degree; ++i) {
            double coeff = nCr(degree, i) * safe_pow(1.0 - t, degree - i) * safe_pow(t, i);
            x += coeff * cx[i];
            y += coeff * cy[i];
        }
        xi = (int)(x + 0.5);
        yi = (int)(y + 0.5);

        if (prev_x == -1) {
            putpixel(xi, yi, GREEN);
        } else {
            line(prev_x, prev_y, xi, yi);
        }
        prev_x = xi;
        prev_y = yi;
    }

    setcolor(RED);
    circle(cx[0], cy[0], 6);
    circle(cx[n - 1], cy[n - 1], 6);

    setcolor(WHITE);
    outtextxy(10, 350, "Bezier Curve (Green)  Control Polygon (White)");
    outtextxy(10, 370, "Press any key to exit...");

    getch();
    closegraph();
    return 0;
}